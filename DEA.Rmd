# Differential Analysis {#DEA}

The overview goes here.

```{r DEA_chunk_opts, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
                      fig.align='center', out.width='75%')
```

```{r DEA_setup, warning=FALSE, message=FALSE}
library(MSnSet.utils)
library(dplyr)
library(ggplot2)

# MSnSet
data("cptac_oca")
```


## Linear Regression

```{r}
res1 <- limma_a_b(oca.set, model.str = "~ AGE", coef.str = "AGE")
head(res1)
```

## One-Way ANOVA

```{r}
res2 <- limma_gen(oca.set, model.str = "~ SUBTYPE", coef.str = "SUBTYPE")
head(res2)
```


## t-tests

### One Comparison

`limma_a_b` is used when there are exactly two levels that are being compared. If the `coef.str` column of the phenotype data is a factor, the first level will be used as the reference. If the `coef.str` column is a character vector, the first unique category will be used as the reference.

```{r}
# Only two-groups
res3 <- limma_a_b(oca.set, model.str = "~ PLATINUM.STATUS", 
                  coef.str = "PLATINUM.STATUS")
head(res3)
```

To count the number of significant features after adjustment, we can use `table` or `sum`.

```{r}
table(res3$adj.P.Val < 0.05)
```

No features are significantly different between the RESISTANT and SENSITIVE `PLATINUM.STATUS` levels after adjustment.

### Multiple Comparisons

`limma_contrasts` is used to perform multiple t-tests at the same time. We can use the `paircomp` function to generate contrasts to be used with `paircomp`.

```{r}
# Pairwise contrasts
contrasts <- paircomp(oca.set$SUBTYPE, name = "SUBTYPE")
contrasts
```

By default, `limma_contrasts` will generate diagnostic plots. We can prevent this by setting `plot` to `FALSE`.

```{r}
res4 <- limma_contrasts(oca.set, model.str = "~ 0 + SUBTYPE", 
                        coef.str = "SUBTYPE", contrasts = contrasts,
                        plot = FALSE)
head(arrange(res4, feature))
```

## p-value Histograms

```{r}
hist(res3$P.Value, 
     breaks = seq(0, 1, 0.05), 
     main = "Histogram of PLATINUM.STATUS ANOVA Results", 
     xlab = "p-value")
```

The histogram is uniform, which means it is unlikely that any features will be significantly different between any two `PLATINUM.STATUS` groups after adjustment for multiple comparisons. Indeed, when we check with `table(res3$adj.P.Val < 0.05)`, none of the features pass the significance threshold after Benjamini-Hochberg (BH) adjustment.


```{r fig.asp=0.6}
# Histogram faceted by contrast
ggplot(res4) +
        geom_histogram(aes(x = P.Value), breaks = seq(0, 1, 0.05),
                       color = "black", fill = "grey") +
        facet_wrap(vars(contrast)) +
        theme_bw()
```

Based on the unadjusted p-values, it appears that there are more features that are significantly different between the Proliferative vs. Immunoreactive comparison than the other two comparisons. We can create a table of the number of features with adjusted p-values less than 0.05 in each comparison with the `table` function.

```{r}
table(res4$contrast, res4$adj.P.Val < 0.05)
```

## Volcano Plots

```{r volcano-plot-base, fig.asp=0.6}
# Basic volcano plot
plot_volcano(df = res4, logFC = "logFC", pvals = "adj.P.Val", 
             sig_threshold = 0.05) +
        facet_wrap(vars(contrast)) +
        labs(y = "BH-adjusted p-value")
```


It looks like there are more features that are significantly lower in the Proliferative group compared to the Immunoreactive group than there are features that are significantly higher. The Differentiated group appears to behave similarly, though with fewer features passing the significance cutoff of 0.05.

Below is an example of how to color points based on sign of the fold-change and whether they are significant.

```{r fig.asp = 0.6, message=FALSE}
# Top 4 most significant features in each contrast
feature_labels <- res4 %>% 
        group_by(contrast) %>%
        slice_min(order_by = adj.P.Val, n = 4, with_ties = FALSE) %>% 
        mutate(feature_label = feature)

res4 <- res4 %>% 
        # Label 5 most significant features in each comparison group
        left_join(feature_labels) %>% 
        # Determine point colors based on significance and sign(logFC)
        mutate(point_color = case_when(
                adj.P.Val < 0.05 & logFC < 0 ~ "down",
                adj.P.Val < 0.05 & logFC > 0 ~ "up",
                TRUE ~ "NS"), 
               point_color_sub = ifelse(!is.na(feature_label), 
                                        point_color, NA))

# Color points
v1 <- plot_volcano(df = res4, logFC = "logFC", pvals = "adj.P.Val", 
                   sig_threshold = 0.05, 
                   point_args = list(mapping = aes(color = point_color))) +
        facet_wrap(vars(contrast))
v1
```

```{r fig.asp=0.6}
# Change colors - do not include "NS"
v1 + scale_color_manual(values = c("#5555ff", "red3", NA), 
                        breaks = c("down", "up", "NS"), 
                        limits = c("down", "up"), 
                        na.value = "lightgrey") +
        theme(legend.position = "none") # do not show legend
```


```{r}
# Label top 4 significant features in each contrast
plot_volcano(df = res4, logFC = "logFC", pvals = "adj.P.Val", 
             sig_threshold = 0.05, label = "feature_label",
             num_features = nrow(res4),
             # Change point and label color
             label_args = list(mapping = aes(color = point_color),
                               size = 2.5, box.padding = 0.75, 
                               force_pull = 0, seed = 99), 
             point_args = list(mapping = aes(color = point_color),
                               alpha = 0.5)) +
        facet_wrap(vars(contrast)) +
        # Point colors
        scale_color_manual(values = c("#5555ff", "red3", NA), 
                           breaks = c("down", "up", "NS"), 
                           limits = c("down", "up"), 
                           na.value = "lightgrey") +
        theme_bw() +
        theme(legend.position = "none") # do not show legend
```


